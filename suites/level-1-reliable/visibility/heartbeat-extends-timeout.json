{
  "test_id": "L1-VIS-002",
  "level": 1,
  "category": "visibility",
  "name": "heartbeat-extends-timeout",
  "description": "Sending a heartbeat for an active job MUST extend the visibility timeout. A job that would otherwise time out MUST remain in the 'active' state as long as heartbeats are sent within the timeout window. After heartbeats stop, the normal timeout behavior MUST resume.",
  "spec_ref": "ojs-worker-protocol#section-6",
  "tags": [
    "level-1",
    "visibility",
    "heartbeat",
    "timeout-extension"
  ],
  "steps": [
    {
      "id": "step-1",
      "action": "POST",
      "intent": "enqueue",
      "path": "/ojs/v1/jobs",
      "headers": {
        "Content-Type": "application/openjobspec+json"
      },
      "body": {
        "type": "visibility.test.heartbeat-extends",
        "args": [
          {
            "action": "long_running_task"
          }
        ],
        "options": {
          "queue": "visibility-test",
          "visibility_timeout": "PT3S"
        }
      },
      "assertions": {
        "status": 201,
        "body": {
          "$.job.id": "string:uuidv7",
          "$.job.state": "available"
        }
      }
    },
    {
      "id": "step-2",
      "action": "POST",
      "intent": "fetch",
      "path": "/ojs/v1/workers/fetch",
      "headers": {
        "Content-Type": "application/openjobspec+json"
      },
      "body": {
        "queues": [
          "visibility-test"
        ],
        "worker_id": "worker-vis-heartbeat-1"
      },
      "assertions": {
        "status": 200,
        "body": {
          "$.job.id": "{{steps.step-1.response.body.job.id}}",
          "$.job.state": "active"
        }
      }
    },
    {
      "id": "step-3",
      "description": "Send first heartbeat at 2s (before 3s timeout)",
      "delay_ms": 2000,
      "action": "POST",
      "intent": "heartbeat",
      "path": "/ojs/v1/workers/heartbeat",
      "headers": {
        "Content-Type": "application/openjobspec+json"
      },
      "body": {
        "job_id": "{{steps.step-1.response.body.job.id}}",
        "worker_id": "worker-vis-heartbeat-1"
      },
      "assertions": {
        "status": 200,
        "body": {
          "$.state": "active"
        }
      }
    },
    {
      "id": "step-4",
      "description": "Send second heartbeat at 4s (past original 3s timeout, but extended by first heartbeat)",
      "delay_ms": 2000,
      "action": "POST",
      "intent": "heartbeat",
      "path": "/ojs/v1/workers/heartbeat",
      "headers": {
        "Content-Type": "application/openjobspec+json"
      },
      "body": {
        "job_id": "{{steps.step-1.response.body.job.id}}",
        "worker_id": "worker-vis-heartbeat-1"
      },
      "assertions": {
        "status": 200,
        "body": {
          "$.state": "active"
        }
      }
    },
    {
      "id": "step-5",
      "description": "Verify job is still active at 5s (well past original 3s timeout)",
      "delay_ms": 1000,
      "action": "GET",
      "intent": "get-job",
      "path": "/ojs/v1/jobs/{{steps.step-1.response.body.job.id}}",
      "headers": {
        "Accept": "application/openjobspec+json"
      },
      "assertions": {
        "status": 200,
        "body": {
          "$.job.state": "active"
        }
      }
    },
    {
      "id": "step-6",
      "action": "POST",
      "intent": "ack",
      "path": "/ojs/v1/workers/ack",
      "headers": {
        "Content-Type": "application/openjobspec+json"
      },
      "body": {
        "job_id": "{{steps.step-1.response.body.job.id}}",
        "worker_id": "worker-vis-heartbeat-1"
      },
      "assertions": {
        "status": 200,
        "body": {
          "$.job.state": "completed"
        }
      }
    }
  ]
}
